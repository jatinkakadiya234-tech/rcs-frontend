import React, { useState, useEffect } from 'react';\nimport { Card, Row, Col, Statistic, Table, Tag, Progress, Badge, Timeline } from 'antd';\nimport { \n  CheckCircleOutlined, \n  ClockCircleOutlined, \n  CloseCircleOutlined,\n  SendOutlined,\n  EyeOutlined,\n  MessageOutlined\n} from '@ant-design/icons';\nimport { io } from 'socket.io-client';\nimport { useAuth } from '../../context/AuthContext';\n\nconst RealTimeReporting = ({ campaignId }) => {\n  const { user, token } = useAuth();\n  const [socket, setSocket] = useState(null);\n  const [stats, setStats] = useState({\n    total: 0,\n    sent: 0,\n    delivered: 0,\n    failed: 0,\n    pending: 0,\n    successRate: 0\n  });\n  const [recentEvents, setRecentEvents] = useState([]);\n  const [messageBreakdown, setMessageBreakdown] = useState([]);\n  const [interactions, setInteractions] = useState({\n    totalClicks: 0,\n    totalReplies: 0,\n    uniqueInteractions: 0\n  });\n\n  useEffect(() => {\n    if (!token || !campaignId) return;\n\n    // Initialize Socket.IO connection\n    const newSocket = io(process.env.REACT_APP_API_URL || 'http://localhost:5000', {\n      auth: { token }\n    });\n\n    newSocket.on('connect', () => {\n      console.log('Connected to real-time updates');\n      newSocket.emit('join_campaign', campaignId);\n      newSocket.emit('request_stats', campaignId);\n    });\n\n    // Listen for real-time updates\n    newSocket.on('message_status_update', (data) => {\n      console.log('Status update:', data);\n      \n      // Update recent events\n      setRecentEvents(prev => [\n        {\n          id: Date.now(),\n          messageId: data.messageId,\n          phoneNumber: data.phoneNumber,\n          status: data.status,\n          timestamp: data.timestamp,\n          eventType: data.eventType\n        },\n        ...prev.slice(0, 19) // Keep only 20 recent events\n      ]);\n      \n      // Refresh stats\n      fetchStats();\n    });\n\n    newSocket.on('user_interaction', (data) => {\n      console.log('User interaction:', data);\n      \n      setRecentEvents(prev => [\n        {\n          id: Date.now(),\n          messageId: data.messageId,\n          phoneNumber: data.phoneNumber,\n          status: 'interaction',\n          interactionType: data.interactionType,\n          text: data.text,\n          timestamp: data.timestamp\n        },\n        ...prev.slice(0, 19)\n      ]);\n      \n      fetchInteractions();\n    });\n\n    newSocket.on('stats_update', (data) => {\n      setStats(data.stats);\n    });\n\n    setSocket(newSocket);\n\n    // Initial data fetch\n    fetchStats();\n    fetchMessageBreakdown();\n    fetchInteractions();\n\n    return () => {\n      newSocket.emit('leave_campaign', campaignId);\n      newSocket.disconnect();\n    };\n  }, [campaignId, token]);\n\n  const fetchStats = async () => {\n    try {\n      const response = await fetch(`/api/realtime/campaign/${campaignId}/stats`, {\n        headers: { Authorization: `Bearer ${token}` }\n      });\n      const data = await response.json();\n      if (data.success) {\n        setStats(data.data);\n      }\n    } catch (error) {\n      console.error('Error fetching stats:', error);\n    }\n  };\n\n  const fetchMessageBreakdown = async () => {\n    try {\n      const response = await fetch(`/api/realtime/campaign/${campaignId}/breakdown`, {\n        headers: { Authorization: `Bearer ${token}` }\n      });\n      const data = await response.json();\n      if (data.success) {\n        setMessageBreakdown(data.data);\n      }\n    } catch (error) {\n      console.error('Error fetching breakdown:', error);\n    }\n  };\n\n  const fetchInteractions = async () => {\n    try {\n      const response = await fetch(`/api/realtime/campaign/${campaignId}/interactions`, {\n        headers: { Authorization: `Bearer ${token}` }\n      });\n      const data = await response.json();\n      if (data.success) {\n        setInteractions(data.data);\n      }\n    } catch (error) {\n      console.error('Error fetching interactions:', error);\n    }\n  };\n\n  const getStatusColor = (status) => {\n    switch (status) {\n      case 'sent': return 'blue';\n      case 'delivered': return 'green';\n      case 'failed': return 'red';\n      case 'pending': return 'orange';\n      case 'interaction': return 'purple';\n      default: return 'default';\n    }\n  };\n\n  const getStatusIcon = (status) => {\n    switch (status) {\n      case 'sent': return <SendOutlined />;\n      case 'delivered': return <CheckCircleOutlined />;\n      case 'failed': return <CloseCircleOutlined />;\n      case 'pending': return <ClockCircleOutlined />;\n      case 'interaction': return <MessageOutlined />;\n      default: return null;\n    }\n  };\n\n  return (\n    <div style={{ padding: '24px' }}>\n      <Row gutter={[16, 16]}>\n        {/* Real-time Stats */}\n        <Col span={24}>\n          <Card title=\"ðŸ“Š Real-Time Campaign Stats\" extra={<Badge status=\"processing\" text=\"Live\" />}>\n            <Row gutter={16}>\n              <Col span={4}>\n                <Statistic\n                  title=\"Total Messages\"\n                  value={stats.total}\n                  prefix={<SendOutlined />}\n                />\n              </Col>\n              <Col span={4}>\n                <Statistic\n                  title=\"Sent\"\n                  value={stats.sent}\n                  valueStyle={{ color: '#1890ff' }}\n                  prefix={<SendOutlined />}\n                />\n              </Col>\n              <Col span={4}>\n                <Statistic\n                  title=\"Delivered\"\n                  value={stats.delivered}\n                  valueStyle={{ color: '#52c41a' }}\n                  prefix={<CheckCircleOutlined />}\n                />\n              </Col>\n              <Col span={4}>\n                <Statistic\n                  title=\"Failed\"\n                  value={stats.failed}\n                  valueStyle={{ color: '#ff4d4f' }}\n                  prefix={<CloseCircleOutlined />}\n                />\n              </Col>\n              <Col span={4}>\n                <Statistic\n                  title=\"Pending\"\n                  value={stats.pending}\n                  valueStyle={{ color: '#fa8c16' }}\n                  prefix={<ClockCircleOutlined />}\n                />\n              </Col>\n              <Col span={4}>\n                <Statistic\n                  title=\"Success Rate\"\n                  value={stats.successRate}\n                  suffix=\"%\"\n                  valueStyle={{ color: stats.successRate > 90 ? '#52c41a' : '#fa8c16' }}\n                />\n              </Col>\n            </Row>\n            \n            <div style={{ marginTop: '16px' }}>\n              <Progress\n                percent={stats.successRate}\n                strokeColor={{\n                  '0%': '#108ee9',\n                  '100%': '#87d068',\n                }}\n                format={(percent) => `${percent}% Success Rate`}\n              />\n            </div>\n          </Card>\n        </Col>\n\n        {/* User Interactions */}\n        <Col span={12}>\n          <Card title=\"ðŸ‘† User Interactions\">\n            <Row gutter={16}>\n              <Col span={8}>\n                <Statistic\n                  title=\"Total Clicks\"\n                  value={interactions.totalClicks}\n                  prefix={<EyeOutlined />}\n                />\n              </Col>\n              <Col span={8}>\n                <Statistic\n                  title=\"Total Replies\"\n                  value={interactions.totalReplies}\n                  prefix={<MessageOutlined />}\n                />\n              </Col>\n              <Col span={8}>\n                <Statistic\n                  title=\"Unique Users\"\n                  value={interactions.uniqueInteractions}\n                />\n              </Col>\n            </Row>\n          </Card>\n        </Col>\n\n        {/* Message Status Breakdown */}\n        <Col span={12}>\n          <Card title=\"ðŸ“ˆ Status Breakdown\">\n            {messageBreakdown.map((item, index) => (\n              <div key={index} style={{ marginBottom: '8px' }}>\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n                  <Tag color={getStatusColor(item._id)} icon={getStatusIcon(item._id)}>\n                    {item._id.toUpperCase()}\n                  </Tag>\n                  <span style={{ fontWeight: 'bold' }}>{item.count}</span>\n                </div>\n                <Progress\n                  percent={(item.count / stats.total) * 100}\n                  size=\"small\"\n                  strokeColor={getStatusColor(item._id)}\n                  showInfo={false}\n                />\n              </div>\n            ))}\n          </Card>\n        </Col>\n\n        {/* Live Event Feed */}\n        <Col span={24}>\n          <Card title=\"ðŸ”´ Live Event Feed\" extra={<Badge status=\"processing\" text=\"Real-time\" />}>\n            <Timeline mode=\"left\">\n              {recentEvents.slice(0, 10).map((event) => (\n                <Timeline.Item\n                  key={event.id}\n                  color={getStatusColor(event.status)}\n                  dot={getStatusIcon(event.status)}\n                >\n                  <div>\n                    <strong>{event.phoneNumber}</strong>\n                    <Tag color={getStatusColor(event.status)} style={{ marginLeft: '8px' }}>\n                      {event.status === 'interaction' ? event.interactionType : event.status}\n                    </Tag>\n                    <div style={{ fontSize: '12px', color: '#666', marginTop: '4px' }}>\n                      {new Date(event.timestamp).toLocaleTimeString()}\n                      {event.text && (\n                        <div style={{ marginTop: '4px', fontStyle: 'italic' }}>\n                          \"{event.text}\"\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </Timeline.Item>\n              ))}\n            </Timeline>\n          </Card>\n        </Col>\n      </Row>\n    </div>\n  );\n};\n\nexport default RealTimeReporting;